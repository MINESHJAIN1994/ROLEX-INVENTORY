<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management Tool - Rolex Fittings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Prose styles for AI-generated markdown content */
        .prose { color: #374151; }
        .prose h1, .prose h2, .prose h3, .prose h4 { color: #1f2937; font-weight: 600; }
        .prose strong { color: #1f2937; font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; }
        .prose li { margin-top: 0.25rem; margin-bottom: 0.25rem; }
        /* Hide elements by default */
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- App Loader -->
    <div id="app-loader" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="text-xl font-semibold text-gray-700">Initializing Inventory System...</div>
    </div>

    <!-- Login View -->
    <div id="login-view" class="hidden flex items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-md bg-white shadow-lg rounded-xl p-6 text-center">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-4">INVENTORY SYSTEM</h1>
            <h2 class="text-xl font-bold text-gray-700 mb-6">ROLEX FITTINGS INDIA PVT LTD</h2>
            <p class="text-red-600 font-semibold mb-4">
                <strong class="text-lg">SECURITY WARNING:</strong> This password is for demonstration only. Do NOT use this system for sensitive data in a real application.
            </p>
            <form id="login-form" class="space-y-4">
                <input
                    type="password"
                    id="password-input"
                    placeholder="Enter Access Password"
                    class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                />
                <p id="auth-error" class="text-red-500 text-sm h-4"></p>
                <button
                    type="submit"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors duration-200 shadow-md"
                >
                    Access Inventory
                </button>
            </form>
        </div>
    </div>

    <!-- Main App View -->
    <div id="main-app" class="hidden min-h-screen bg-gray-100 p-4 flex-col items-center">
        <div class="w-full max-w-7xl bg-white shadow-lg rounded-xl p-6 mb-8">
            <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-2">INVENTORY SYSTEM</h1>
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">ROLEX FITTINGS INDIA PVT LTD</h2>

            <div id="message-box" class="hidden p-3 mb-4 rounded-lg text-center font-medium"></div>

            <div class="flex justify-center mb-6 border-b">
                <button id="view-inventory-btn" class="px-6 py-3 font-semibold transition-all duration-300 border-b-2 border-blue-600 text-blue-600">
                    Inventory IN/OUT
                </button>
                <button id="view-reports-btn" class="px-6 py-3 font-semibold transition-all duration-300 text-gray-500 hover:text-blue-500">
                    Reports
                </button>
            </div>

            <!-- Inventory View -->
            <div id="inventory-view">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Transaction Form -->
                    <div class="bg-blue-50 p-6 rounded-xl shadow-inner">
                        <h2 class="text-2xl font-bold text-blue-800 mb-4">Record Transaction</h2>
                        <div id="transaction-form" class="grid grid-cols-1 gap-4">
                            <!-- Form fields will be injected here by JS -->
                        </div>
                    </div>
                    <!-- Transaction Records -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Transaction Search</h2>
                        <p class="text-sm text-gray-500 mb-4">Double-click a row to quickly populate the form for a new transaction.</p>
                        <input type="text" id="search-inventory-records" placeholder="Search all transactions..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <div class="overflow-auto max-h-[600px] custom-scrollbar mt-4">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg text-sm">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Grade</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Size</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Sch</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Origin</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Seam</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Location</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Qty</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">By</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Remarks</th>
                                        <th class="p-2 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-records-table-body">
                                    <!-- Rows will be injected by JS -->
                                </tbody>
                            </table>
                            <p id="no-records-message" class="text-center text-gray-500 py-8 hidden">No inventory records found.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reports-view" class="hidden bg-white p-6 rounded-xl shadow-md">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4">Current Stock Report</h2>
                 <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-4 items-end" id="report-filters">
                    <!-- Filters will be injected here by JS -->
                 </div>
                 <div id="ai-summary-container" class="my-4 p-4 border rounded-lg bg-gray-50 hidden">
                    <h3 class="text-lg font-bold text-purple-800 mb-2">AI Report Summary</h3>
                    <div id="summary-loader" class="hidden text-center p-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-700 mx-auto"></div>
                        <p class="mt-2">Generating insights...</p>
                    </div>
                    <div id="report-summary-content" class="prose prose-sm max-w-none"></div>
                 </div>
                 <input type="text" id="search-current-stock" placeholder="Search current stock..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                 <div class="overflow-auto max-h-[600px] custom-scrollbar mt-4">
                     <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                         <thead class="bg-gray-100 sticky top-0">
                             <tr>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Category</th>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Grade</th>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Size 1</th>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Size 2</th>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Schedule</th>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Origin</th>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Seam</th>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Location</th>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Current Stock</th>
                                 <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Remarks</th>
                             </tr>
                         </thead>
                         <tbody id="reports-table-body">
                             <!-- Rows will be injected by JS -->
                         </tbody>
                     </table>
                     <p id="no-stock-message" class="text-center text-gray-500 py-8 hidden">No current stock found matching your filters.</p>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modals-container">
        <!-- All modals will be injected and managed here by JS -->
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, updateDoc, doc, getDoc, writeBatch, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE AND CONFIG ---

        // Firebase and App Config
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-inventory-app-html';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const ACCESS_PASSWORD = "rolexpassword";

        // Firebase services
        let db, auth;

        // App State
        let userId = null;
        let isAuthenticated = false;
        let currentView = 'inventory';
        let formState = {};
        
        // Data State
        let categories = [], grades = [], sizes = [], schedules = [], locations = [];
        let inventoryRecords = [], batches = [];
        let currentStock = [];
        
        // Predefined Data
        const predefinedCategories = ["SR ELBOW", "LR ELBOW", "45 ELBOW", "EQUAL TEE", "UNEQUAL TEE", "CON RED", "ECC RED", "STUBEND", "CAP"];
        const predefinedGrades = ["304", "304H", "316", "321", "316TI", "DUPLEX2205", "DUPLEX31803", "SUPERDUPLEX32750", "SUPERDUPLEXZ32760", "INCONEL625", "TITANIUM"];
        const predefinedSizes = ["1/2\"", "3/4\"", "1\"", "1-1/4\"", "1-1/2\"", "2\"", "2-1/2\"", "3\"", "4\"", "6\"", "8\"", "10\"", "12\"", "14\"", "16\"", "18\"", "20\"", "24\"", "22\"", "26\"", "28\"", "30\"", "32\"", "36\"", "40\"", "42\""];
        const predefinedSchedules = ["S10", "S10S", "S5", "S40", "S40S", "S80", "S80S", "S120", "S100", "S160", "XXS", "S20", "S40SXS80S", "S40SXSCH10S", "S60XS80", "S60XS40", "S10XS40", "S40XS10", "S80XS40", "XXS X 160", "S30XS10S", "S20XS40", "S40XS160", "S80SXS40S", "S20XS10", "S40SXS20", "S30", "S80SXS20", "S60", "S20XS10"];
        const predefinedOrigins = ["IMPORTED", "CHINA", "INDIAN"];
        const predefinedSeamConditions = ["SEAMLESS", "PW", "2JOINT"];
        const predefinedLocations = ["TALOJA GODOWN", "DONGRI GODOWN", "OFFICE GODOWN"];
        const dualSizeCategories = ["UNEQUAL TEE", "CON RED", "ECC RED"];

        // DOM Element References
        const appLoader = document.getElementById('app-loader');
        const loginView = document.getElementById('login-view');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const authError = document.getElementById('auth-error');
        const messageBox = document.getElementById('message-box');
        const viewInventoryBtn = document.getElementById('view-inventory-btn');
        const viewReportsBtn = document.getElementById('view-reports-btn');
        const inventoryView = document.getElementById('inventory-view');
        const reportsView = document.getElementById('reports-view');
        const transactionFormContainer = document.getElementById('transaction-form');
        const inventoryRecordsTableBody = document.getElementById('inventory-records-table-body');
        const reportsTableBody = document.getElementById('reports-table-body');
        const reportFiltersContainer = document.getElementById('report-filters');
        const noRecordsMessage = document.getElementById('no-records-message');
        const noStockMessage = document.getElementById('no-stock-message');
        const modalsContainer = document.getElementById('modals-container');
        
        // --- HELPER FUNCTIONS ---

        const showMessage = (text, type) => {
            messageBox.textContent = text;
            messageBox.className = `p-3 mb-4 rounded-lg text-center font-medium ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            setTimeout(() => { messageBox.className = 'hidden'; }, 5000);
        };

        const parseSizeToNumber = (sizeStr) => {
            if (typeof sizeStr !== 'string') return 0;
            const cleanStr = sizeStr.replace(/"/g, '').trim();
            if (cleanStr.includes('-') && cleanStr.includes('/')) {
                const parts = cleanStr.split('-');
                return parseFloat(parts[0]) + (parseFloat(parts[1].split('/')[0]) / parseFloat(parts[1].split('/')[1]));
            }
            if (cleanStr.includes('/')) {
                const parts = cleanStr.split('/');
                return parseFloat(parts[0]) / parseFloat(parts[1]);
            }
            return parseFloat(cleanStr) || 0;
        };
        
        const filterRecordsByKeywords = (records, query) => {
            const keywords = query.toLowerCase().split(' ').filter(kw => kw.trim() !== '');
            if (keywords.length === 0) return records;
            return records.filter(record => {
                const searchableString = [record.category, record.grade, record.size, record.size1, record.size2, record.schedule, record.origin, record.seamCondition, record.location, record.entryBy, record.remarks].filter(Boolean).join(' ').toLowerCase();
                return keywords.every(keyword => searchableString.includes(keyword));
            });
        };

        // --- RENDER FUNCTIONS ---

        const renderSelectField = (label, id, options, selectedValue, onAddClick, showAddButton = true) => {
            const optionsHtml = options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            const addButtonHtml = showAddButton ? `
                <button type="button" data-modal-target="${id}" class="p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                </button>` : '';

            return `
                <div class="flex flex-col">
                    <label for="${id}" class="text-gray-700 font-medium mb-1">${label}</label>
                    <div class="flex items-center space-x-2">
                        <select id="${id}" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="" disabled>Select ${label}</option>
                            ${optionsHtml}
                        </select>
                        ${addButtonHtml}
                    </div>
                </div>`;
        };
        
        const renderInputField = (label, id, type, value, placeholder, rows = 3) => {
            if (type === 'textarea') {
                return `<div class="flex flex-col"><label for="${id}" class="text-gray-700 font-medium mb-1">${label}</label><textarea id="${id}" rows="${rows}" class="p-2 border border-gray-300 rounded-md" placeholder="${placeholder}">${value}</textarea></div>`;
            }
            return `<div class="flex flex-col"><label for="${id}" class="text-gray-700 font-medium mb-1">${label}</label><input type="${type}" id="${id}" value="${value}" class="p-2 border border-gray-300 rounded-md" placeholder="${placeholder}"></div>`;
        };

        const renderTransactionForm = () => {
            const isDual = dualSizeCategories.includes(formState.category);
            const availableBatches = getAvailableBatchesForOut();
            const currentStockForCombo = getCurrentStockForFormCombination();

            const sizeFieldsHtml = isDual ?
                renderSelectField('Size 1', 'form-size1', sizes, formState.size1, () => openAddModal('size')) +
                renderSelectField('Size 2', 'form-size2', sizes, formState.size2, () => openAddModal('size'))
                : renderSelectField('Size', 'form-size', sizes, formState.size, () => openAddModal('size'));

            const batchSelectHtml = availableBatches.length > 0 ? `
                <div class="flex flex-col">
                    <label for="form-selectBatch" class="text-gray-700 font-medium mb-1">Select Batch to Deduct From (for OUT)</label>
                    <select id="form-selectBatch" class="p-2 border border-gray-300 rounded-md bg-white">
                        <option value="">-- Select a specific batch --</option>
                        ${availableBatches.map(b => `<option value="${b.id}">IN: ${b.inDate} | Qty: ${b.currentQuantity}</option>`).join('')}
                    </select>
                </div>` : '';

            transactionFormContainer.innerHTML = `
                ${renderInputField('Entry By (Your Name)', 'form-entryBy', 'text', formState.entryBy, 'Enter your name')}
                ${renderSelectField('Product Category', 'form-category', categories, formState.category, () => openAddModal('category'))}
                ${renderSelectField('Grade', 'form-grade', grades, formState.grade, () => openAddModal('grade'))}
                ${sizeFieldsHtml}
                ${renderSelectField('Schedule Thickness', 'form-schedule', schedules, formState.schedule, () => openAddModal('schedule'))}
                ${renderSelectField('Origin', 'form-origin', predefinedOrigins, formState.origin, null, false)}
                ${renderSelectField('Seam Condition', 'form-seamCondition', predefinedSeamConditions, formState.seamCondition, null, false)}
                ${renderSelectField('Location', 'form-location', locations, formState.location, () => openAddModal('location'))}
                ${batchSelectHtml}
                ${renderInputField('Quantity', 'form-quantity', 'number', formState.quantity, 'Enter quantity')}
                ${renderInputField('Date', 'form-date', 'date', formState.date, '')}
                <div class="p-3 bg-blue-100 rounded-md text-blue-800 font-semibold text-center">
                    Current Stock for this combination: ${currentStockForCombo ?? '0'}
                </div>
                ${renderInputField('Remarks (Optional)', 'form-remarks', 'textarea', formState.remarks, 'Add any general comments here...')}
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <button id="btn-inventory-in" class="col-span-1 bg-green-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-green-700 shadow-md">Inventory IN</button>
                    <button id="btn-inventory-out" class="col-span-1 bg-red-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-red-700 shadow-md">Inventory OUT</button>
                    <div class="col-span-2">
                        <button id="btn-clear-form" class="w-full bg-gray-500 text-white py-2 rounded-lg font-semibold hover:bg-gray-600 shadow-md">Clear Form</button>
                    </div>
                </div>
            `;
            addFormEventListeners();
        };

        const renderInventoryTable = () => {
            const query = document.getElementById('search-inventory-records').value;
            const filtered = filterRecordsByKeywords(inventoryRecords, query);
            const sorted = filtered.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

            if (sorted.length === 0) {
                inventoryRecordsTableBody.innerHTML = '';
                noRecordsMessage.classList.remove('hidden');
                return;
            }
            noRecordsMessage.classList.add('hidden');
            inventoryRecordsTableBody.innerHTML = sorted.map(record => {
                const sizeDisplay = dualSizeCategories.includes(record.category) ? `${record.size1 || ''}x${record.size2 || ''}` : record.size || '';
                const typeClass = record.type === 'EDIT' ? 'text-yellow-600' : record.quantity > 0 ? 'text-green-600' : 'text-red-600';
                const qtyDisplay = record.type === 'EDIT' ? '-' : Math.abs(record.quantity);
                const actionsHtml = record.type !== 'EDIT' ?
                    `<button data-action="edit-transaction" data-id="${record.id}" class="px-2 py-1 bg-blue-500 text-white rounded-md text-xs hover:bg-blue-600">Edit</button>` : '';

                return `
                    <tr data-record-id="${record.id}" class="hover:bg-gray-50 transition-colors duration-150 cursor-pointer">
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${record.date}</td>
                        <td class="p-2 border-b text-xs font-semibold whitespace-nowrap ${typeClass}">${record.type}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${record.category}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${record.grade}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${sizeDisplay}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${record.schedule}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${record.origin}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${record.seamCondition}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${record.location}</td>
                        <td class="p-2 border-b text-xs text-center font-semibold ${typeClass}">${qtyDisplay}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${record.entryBy}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap">${record.remarks || '-'}</td>
                        <td class="p-2 border-b text-xs text-gray-700 whitespace-nowrap space-x-1">
                            ${actionsHtml}
                            <button data-action="delete-transaction" data-id="${record.id}" class="px-2 py-1 bg-red-600 text-white rounded-md text-xs hover:bg-red-700">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };
        
        const renderReportsView = () => {
            renderReportFilters();
            renderReportsTable();
        };

        const renderReportFilters = () => {
            reportFiltersContainer.innerHTML = `
                ${renderSelectField('Category', 'report-category-filter', ['', ...categories], '', null, false)}
                ${renderSelectField('Grade', 'report-grade-filter', ['', ...grades], '', null, false)}
                ${renderSelectField('Size', 'report-size-filter', ['', ...sizes], '', null, false)}
                ${renderSelectField('Schedule', 'report-schedule-filter', ['', ...schedules], '', null, false)}
                ${renderSelectField('Origin', 'report-origin-filter', ['', ...predefinedOrigins], '', null, false)}
                ${renderSelectField('Seam', 'report-seam-filter', ['', ...predefinedSeamConditions], '', null, false)}
                ${renderSelectField('Location', 'report-location-filter', ['', ...locations], '', null, false)}
                <div class="flex space-x-2">
                    <button id="btn-export-csv" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-md h-10">Export CSV</button>
                    <button id="btn-generate-summary" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 shadow-md h-10">✨ Generate Summary</button>
                </div>
            `;
            addReportFilterEventListeners();
        };

        const renderReportsTable = () => {
            const catFilter = document.getElementById('report-category-filter')?.value || '';
            const gradeFilter = document.getElementById('report-grade-filter')?.value || '';
            const sizeFilter = document.getElementById('report-size-filter')?.value || '';
            const schFilter = document.getElementById('report-schedule-filter')?.value || '';
            const originFilter = document.getElementById('report-origin-filter')?.value || '';
            const seamFilter = document.getElementById('report-seam-filter')?.value || '';
            const locFilter = document.getElementById('report-location-filter')?.value || '';
            const searchQuery = document.getElementById('search-current-stock').value;

            const filteredByDropdowns = currentStock.filter(item => 
                (catFilter === '' || item.category === catFilter) &&
                (gradeFilter === '' || item.grade === gradeFilter) &&
                (schFilter === '' || item.schedule === schFilter) &&
                (originFilter === '' || item.origin === originFilter) &&
                (seamFilter === '' || item.seamCondition === seamFilter) &&
                (locFilter === '' || item.location === locFilter) &&
                (sizeFilter === '' || (dualSizeCategories.includes(item.category) ? (item.size1 === sizeFilter || item.size2 === sizeFilter) : item.size === sizeFilter))
            );
            
            const filtered = filterRecordsByKeywords(filteredByDropdowns, searchQuery);
            const sorted = filtered.sort((a, b) => a.category.localeCompare(b.category) || (a.size || a.size1).localeCompare(b.size || b.size1));

            if (sorted.length === 0) {
                reportsTableBody.innerHTML = '';
                noStockMessage.classList.remove('hidden');
                return;
            }
            noStockMessage.classList.add('hidden');
            reportsTableBody.innerHTML = sorted.map(item => {
                const size1 = item.size1 || item.size || '-';
                const size2 = item.size2 || '-';
                const qtyClass = item.quantity > 0 ? 'text-green-600' : 'text-red-600';
                return `
                    <tr data-item='${JSON.stringify(item)}' class="hover:bg-gray-50 transition-colors duration-150 cursor-pointer">
                        <td class="py-2 px-4 border-b text-sm text-gray-800">${item.category}</td>
                        <td class="py-2 px-4 border-b text-sm text-gray-800">${item.grade}</td>
                        <td class="py-2 px-4 border-b text-sm text-gray-800">${size1}</td>
                        <td class="py-2 px-4 border-b text-sm text-gray-800">${size2}</td>
                        <td class="py-2 px-4 border-b text-sm text-gray-800">${item.schedule}</td>
                        <td class="py-2 px-4 border-b text-sm text-gray-800">${item.origin}</td>
                        <td class="py-2 px-4 border-b text-sm text-gray-800">${item.seamCondition}</td>
                        <td class="py-2 px-4 border-b text-sm text-gray-800">${item.location}</td>
                        <td class="py-2 px-4 border-b text-sm font-semibold ${qtyClass}">${item.quantity}</td>
                        <td class="py-2 px-4 border-b text-sm text-gray-800">${item.remarks || '-'}</td>
                    </tr>
                `;
            }).join('');
        };
        
        // --- EVENT HANDLERS & LOGIC ---
        
        const initializeAppLogic = () => {
            appLoader.classList.add('hidden');
            loginView.classList.remove('hidden');
            loginForm.addEventListener('submit', handlePasswordSubmit);
        };
        
        const handlePasswordSubmit = (e) => {
            e.preventDefault();
            if (passwordInput.value === ACCESS_PASSWORD) {
                isAuthenticated = true;
                authError.textContent = '';
                loginView.classList.add('hidden');
                mainApp.classList.remove('hidden');
                startDataListeners();
            } else {
                authError.textContent = 'Incorrect password. Please try again.';
            }
        };
        
        const startDataListeners = () => {
            if (!db || !userId) return;

            // Master Data Listeners
            setupMasterDataListener('categories', (data) => { categories = data; resetForm(); renderTransactionForm(); renderReportsView(); }, predefinedCategories);
            setupMasterDataListener('grades', (data) => { grades = data; resetForm(); renderTransactionForm(); renderReportsView(); }, predefinedGrades);
            setupMasterDataListener('sizes', (data) => { sizes = data.sort((a, b) => parseSizeToNumber(a) - parseSizeToNumber(b)); resetForm(); renderTransactionForm(); renderReportsView(); }, predefinedSizes);
            setupMasterDataListener('schedules', (data) => { schedules = data; resetForm(); renderTransactionForm(); renderReportsView(); }, predefinedSchedules);
            setupMasterDataListener('locations', (data) => { locations = data; resetForm(); renderTransactionForm(); renderReportsView(); }, predefinedLocations);

            // Transaction & Batch Listeners
            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/inventory_records`)), (snapshot) => {
                inventoryRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInventoryTable();
            });
            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/batches`)), (snapshot) => {
                batches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                calculateCurrentStock();
                renderReportsTable();
                renderTransactionForm(); // To update available batches and stock count
            });
        };
        
        const setupMasterDataListener = (collectionName, updateStateCallback, predefinedData) => {
            const q = query(collection(db, `artifacts/${appId}/public/data/${collectionName}`));
            onSnapshot(q, async (snapshot) => {
                let items = snapshot.docs.map(doc => doc.data().name);
                if (items.length === 0 && predefinedData.length > 0) {
                    const batch = writeBatch(db);
                    predefinedData.forEach(item => {
                        const docRef = doc(collection(db, `artifacts/${appId}/public/data/${collectionName}`));
                        batch.set(docRef, { name: item });
                    });
                    await batch.commit();
                    items = predefinedData;
                }
                updateStateCallback(items);
            });
        };
        
        const calculateCurrentStock = () => {
            const stockMap = new Map();
            batches.forEach(batch => {
                const isDual = dualSizeCategories.includes(batch.category);
                const key = [batch.category, batch.grade, isDual ? batch.size1 : batch.size, isDual ? batch.size2 : '', batch.schedule, batch.origin, batch.seamCondition, batch.location].join('|');
                const existing = stockMap.get(key);
                if (existing) {
                    existing.quantity += batch.currentQuantity;
                    if(batch.remarks && !existing.remarks.includes(batch.remarks)) existing.remarks.push(batch.remarks);
                } else {
                    stockMap.set(key, { ...batch, quantity: batch.currentQuantity, remarks: batch.remarks ? [batch.remarks] : [] });
                }
            });
            currentStock = Array.from(stockMap.values()).map(item => ({...item, remarks: item.remarks.join('; ')}));
        };
        
        const resetForm = () => {
            formState = {
                entryBy: formState.entryBy || '',
                category: categories[0] || '',
                grade: grades[0] || '',
                size: sizes[0] || '',
                size1: sizes[0] || '',
                size2: sizes[0] || '',
                schedule: schedules[0] || '',
                origin: predefinedOrigins[0] || '',
                seamCondition: predefinedSeamConditions[0] || '',
                location: locations[0] || '',
                quantity: '',
                date: new Date().toISOString().split('T')[0],
                remarks: '',
                selectedBatchId: ''
            };
            renderTransactionForm();
        };

        const updateFormStateFromUI = () => {
            formState.entryBy = document.getElementById('form-entryBy')?.value || '';
            formState.category = document.getElementById('form-category')?.value || '';
            formState.grade = document.getElementById('form-grade')?.value || '';
            formState.size = document.getElementById('form-size')?.value || '';
            formState.size1 = document.getElementById('form-size1')?.value || '';
            formState.size2 = document.getElementById('form-size2')?.value || '';
            formState.schedule = document.getElementById('form-schedule')?.value || '';
            formState.origin = document.getElementById('form-origin')?.value || '';
            formState.seamCondition = document.getElementById('form-seamCondition')?.value || '';
            formState.location = document.getElementById('form-location')?.value || '';
            formState.quantity = document.getElementById('form-quantity')?.value || '';
            formState.date = document.getElementById('form-date')?.value || '';
            formState.remarks = document.getElementById('form-remarks')?.value || '';
            formState.selectedBatchId = document.getElementById('form-selectBatch')?.value || '';
        };
        
        const getAvailableBatchesForOut = () => {
            const { category, grade, size, size1, size2, schedule, origin, seamCondition, location } = formState;
            if (!category || !grade || !schedule || !origin || !seamCondition || !location) return [];
            const isDual = dualSizeCategories.includes(category);
            if ((isDual && (!size1 || !size2)) || (!isDual && !size)) return [];
            return batches.filter(b => b.category === category && b.grade === grade && b.schedule === schedule && b.origin === origin && b.seamCondition === seamCondition && b.location === location && b.currentQuantity > 0 && (isDual ? (b.size1 === size1 && b.size2 === size2) : (b.size === size))).sort((a,b) => (a.inDate || '').localeCompare(b.inDate || ''));
        };

        const getCurrentStockForFormCombination = () => {
            if (formState.selectedBatchId) {
                return batches.find(b => b.id === formState.selectedBatchId)?.currentQuantity ?? 'N/A';
            }
            return getAvailableBatchesForOut().reduce((total, batch) => total + batch.currentQuantity, 0);
        };
        
        const handleInventoryTransaction = async (type) => {
            if (!db || !userId) { showMessage('Authentication required.', 'error'); return; }
            updateFormStateFromUI();
            
            const { category, grade, size, size1, size2, schedule, origin, seamCondition, quantity, date, location, entryBy, selectedBatchId, remarks } = formState;
            const isDual = dualSizeCategories.includes(category);
            const commonFieldsFilled = category && grade && schedule && origin && seamCondition && quantity && date && location && entryBy.trim();
            const sizeFieldsFilled = isDual ? (size1 && size2) : size;

            if (!commonFieldsFilled || !sizeFieldsFilled) { showMessage('Please fill in all required fields, including "Entry By".', 'error'); return; }
            
            const parsedQuantity = parseInt(quantity);
            if (isNaN(parsedQuantity) || parsedQuantity <= 0) { showMessage('Quantity must be a positive number.', 'error'); return; }

            try {
                if (type === 'IN') {
                    const batchData = { category, grade, schedule, origin, seamCondition, location, initialQuantity: parsedQuantity, currentQuantity: parsedQuantity, inDate: date, remarks: remarks || '', entryBy: entryBy.trim(), timestamp: serverTimestamp(), ...(isDual ? { size1, size2 } : { size }) };
                    const newBatchRef = await addDoc(collection(db, `artifacts/${appId}/public/data/batches`), batchData);
                    await addDoc(collection(db, `artifacts/${appId}/public/data/inventory_records`), { ...batchData, quantity: parsedQuantity, type: 'IN', batchId: newBatchRef.id });
                    showMessage(`Inventory IN successful! New batch created.`, 'success');
                } else if (type === 'OUT') {
                    if (!selectedBatchId) { showMessage('Please select a batch to deduct from.', 'error'); return; }
                    const batchToUpdate = batches.find(b => b.id === selectedBatchId);
                    if (!batchToUpdate) { showMessage('Selected batch not found.', 'error'); return; }
                    if (parsedQuantity > batchToUpdate.currentQuantity) { showMessage(`Cannot deduct ${parsedQuantity}. Only ${batchToUpdate.currentQuantity} available.`, 'error'); return; }

                    const batchDocRef = doc(db, `artifacts/${appId}/public/data/batches`, selectedBatchId);
                    await updateDoc(batchDocRef, { currentQuantity: batchToUpdate.currentQuantity - parsedQuantity });
                    const recordData = { category: batchToUpdate.category, grade: batchToUpdate.grade, schedule: batchToUpdate.schedule, origin: batchToUpdate.origin, seamCondition: batchToUpdate.seamCondition, location: batchToUpdate.location, quantity: -parsedQuantity, date, remarks: remarks || '', type: 'OUT', batchId: selectedBatchId, entryBy: entryBy.trim(), timestamp: serverTimestamp(), ...(dualSizeCategories.includes(batchToUpdate.category) ? { size1: batchToUpdate.size1, size2: batchToUpdate.size2 } : { size: batchToUpdate.size }) };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/inventory_records`), recordData);
                    showMessage(`Inventory OUT successful from selected batch.`, 'success');
                }
                formState.quantity = '';
                formState.remarks = '';
                formState.selectedBatchId = '';
                formState.date = new Date().toISOString().split('T')[0];
                renderTransactionForm();
            } catch (error) {
                console.error(`Error processing inventory ${type} transaction:`, error);
                showMessage(`Failed to process inventory ${type}.`, 'error');
            }
        };

        // --- EVENT LISTENERS ---
        
        function addFormEventListeners() {
            document.getElementById('btn-inventory-in')?.addEventListener('click', () => handleInventoryTransaction('IN'));
            document.getElementById('btn-inventory-out')?.addEventListener('click', () => handleInventoryTransaction('OUT'));
            document.getElementById('btn-clear-form')?.addEventListener('click', resetForm);
            
            // Re-render form on change to update dependent fields like available batches
            ['form-category', 'form-grade', 'form-size', 'form-size1', 'form-size2', 'form-schedule', 'form-origin', 'form-seamCondition', 'form-location'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', () => {
                        updateFormStateFromUI();
                        renderTransactionForm();
                    });
                }
            });
            
            document.getElementById('form-selectBatch')?.addEventListener('change', () => {
                updateFormStateFromUI();
                renderTransactionForm();
            });

            document.querySelectorAll('[data-modal-target]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const modalType = e.currentTarget.dataset.modalTarget.replace('form-','');
                    openAddModal(modalType);
                });
            });
        }
        
        function addReportFilterEventListeners() {
            ['report-category-filter', 'report-grade-filter', 'report-size-filter', 'report-schedule-filter', 'report-origin-filter', 'report-seam-filter', 'report-location-filter'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', renderReportsTable);
            });
            document.getElementById('btn-export-csv')?.addEventListener('click', handleExportCsv);
            document.getElementById('btn-generate-summary')?.addEventListener('click', handleGenerateSummary);
        }

        viewInventoryBtn.addEventListener('click', () => {
            currentView = 'inventory';
            inventoryView.classList.remove('hidden');
            reportsView.classList.add('hidden');
            viewInventoryBtn.classList.add('border-blue-600', 'text-blue-600');
            viewReportsBtn.classList.remove('border-blue-600', 'text-blue-600');
        });
        
        viewReportsBtn.addEventListener('click', () => {
            currentView = 'reports';
            inventoryView.classList.add('hidden');
            reportsView.classList.remove('hidden');
            viewReportsBtn.classList.add('border-blue-600', 'text-blue-600');
            viewInventoryBtn.classList.remove('border-blue-600', 'text-blue-600');
        });

        document.getElementById('search-inventory-records').addEventListener('input', renderInventoryTable);
        document.getElementById('search-current-stock').addEventListener('input', renderReportsTable);
        
        // Event delegation for dynamic tables
        inventoryRecordsTableBody.addEventListener('dblclick', (e) => {
            const row = e.target.closest('tr');
            if (row && row.dataset.recordId) {
                const record = inventoryRecords.find(r => r.id === row.dataset.recordId);
                if (record) {
                    formState = { ...formState, category: record.category, grade: record.grade, size: record.size, size1: record.size1, size2: record.size2, schedule: record.schedule, origin: record.origin, seamCondition: record.seamCondition, location: record.location, quantity: '', remarks: '', selectedBatchId: '' };
                    renderTransactionForm();
                    showMessage('Form populated. Enter new quantity and details.', 'success');
                }
            }
        });
        
        inventoryRecordsTableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.action === 'edit-transaction') {
                const record = inventoryRecords.find(r => r.id === button.dataset.id);
                if (record) openEditTransactionModal(record);
            }
            if (button && button.dataset.action === 'delete-transaction') {
                const record = inventoryRecords.find(r => r.id === button.dataset.id);
                if (record) openDeleteConfirmModal(record);
            }
        });

        reportsTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (row && row.dataset.item) {
                const item = JSON.parse(row.dataset.item);
                openHistoryModal(item);
            }
        });

        // --- MODAL LOGIC (Simplified stubs, would need full implementation) ---
        // This section would contain functions to create, show, and handle modals
        // for adding master data, editing, deleting, adjusting, etc.
        // For brevity, only showing the structure for one type of modal.

        const openAddModal = (type) => {
            const titleMap = { category: 'Category', grade: 'Grade', size: 'Size', schedule: 'Schedule', location: 'Location' };
            const modalHtml = `
                <div id="add-master-data-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Add New ${titleMap[type]}</h3>
                        <input id="new-item-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter new name">
                        <div class="flex justify-end space-x-3 mt-4">
                            <button id="modal-cancel" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400">Cancel</button>
                            <button id="modal-save" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Save</button>
                        </div>
                    </div>
                </div>
            `;
            modalsContainer.innerHTML = modalHtml;
            document.getElementById('modal-cancel').addEventListener('click', () => modalsContainer.innerHTML = '');
            document.getElementById('modal-save').addEventListener('click', () => handleAddMasterData(type));
        };
        
        const handleAddMasterData = async (type) => {
            const collectionName = `${type}s`;
            const newItemName = document.getElementById('new-item-name').value.trim();
            if (!db || !userId || !newItemName) {
                showMessage('Please enter a valid name.', 'error');
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/${collectionName}`), { name: newItemName });
                showMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} "${newItemName}" added successfully!`, 'success');
                modalsContainer.innerHTML = ''; // Close modal
            } catch (error) {
                console.error(`Error adding new ${type}:`, error);
                showMessage(`Failed to add new ${type}.`, 'error');
            }
        };

        // Placeholder for other modals (History, Edit, Delete etc.)
        const openHistoryModal = (item) => { /* Complex implementation needed */ showMessage(`History for ${item.category} clicked. Full modal not implemented in this version.`, 'success'); };
        const openEditTransactionModal = (record) => { /* Complex implementation needed */ showMessage(`Edit for transaction ${record.id} clicked. Full modal not implemented.`, 'success'); };
        const openDeleteConfirmModal = (record) => { /* Complex implementation needed */ showMessage(`Delete for transaction ${record.id} clicked. Full modal not implemented.`, 'success'); };
        const handleExportCsv = () => { /* Complex implementation needed */ showMessage('CSV Export clicked. Full functionality not implemented.', 'success'); };
        const handleGenerateSummary = async () => { /* Complex implementation needed */ showMessage('Generate Summary clicked. Full functionality not implemented.', 'success'); };

        // --- INITIALIZATION ---
        
        window.onload = () => {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing.");
                appLoader.textContent = "Error: Firebase configuration is missing.";
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            await signInAnonymously(auth);
                        }
                    }
                    if (!isAuthenticated) {
                        initializeAppLogic();
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                appLoader.textContent = "Error initializing the application.";
            }
        };

    </script>
</body>
</html>
